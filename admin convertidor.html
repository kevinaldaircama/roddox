<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin - Retiros</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"/>
  <link rel="icon" href="3440119_ico.png" />
  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#121212" />
  <link rel="icon" type="image/png" href="3440119_ico.png">

  <!-- Open Graph -->
  <meta property="og:title" content="¬°√önete a Transferencia VIP y gana cr√©ditos!" />
  <meta property="og:description" content="Reg√≠strate con este enlace de referido y recibe hasta 10 cr√©ditos gratis. Empieza a ganar hoy." />
  <meta property="og:image" content="https://transferenciavip.xyz/3440119_ico.png" />
  <meta property="og:url" content="https://transferenciavip.xyz" />
  <meta property="og:type" content="website" />
  <!-- Twitter Cards -->
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="¬°Gana cr√©ditos con Transferencia VIP!" />
  <meta name="twitter:description" content="Reg√≠strate con un referido y recibe bonificaciones instant√°neas." />
  <meta name="twitter:image" content="https://transferenciavip.xyz/3440119_ico.png" />
  
  <style>
    body { background: #111; color: #fff; padding: 2rem; font-family: Arial; }
    .table td, .table th { color: #fff; vertical-align: middle; }
    .table th { background-color: #222; }
    .btn-sm { margin-right: 5px; }
    .estado-pendiente { color: orange; }
    .estado-aprobado { color: lime; }
    .estado-rechazado { color: red; }
  </style>
</head>
<body>
  <h2>üìã Panel de Solicitudes de Retiros</h2>

  <select id="filtroEstado" class="form-select w-auto mb-3">
    <option value="todos">Todos</option>
    <option value="pendiente">Pendiente</option>
    <option value="aprobado">Aprobado</option>
    <option value="rechazado">Rechazado</option>
    <option value="reciente">M√°s reciente</option>
    <option value="antiguo">M√°s antiguo</option>
  </select>

  <table class="table table-dark table-bordered table-hover">
    <thead>
      <tr>
        <th>UID</th><th>Correo</th><th>Monto</th><th>Billetera</th><th>N√∫mero</th><th>Estado</th><th>Acciones</th>
      </tr>
    </thead>
    <tbody id="tablaRetiros"></tbody>
  </table>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script>
const firebaseConfig = {
  apiKey: "AIzaSyCbL1fRbwVZRhdD88TeQSFgpvfjZOMwfIg",
    authDomain: "multidoxnetfree.firebaseapp.com",
    databaseURL: "https://multidoxnetfree-default-rtdb.firebaseio.com",
    projectId: "multidoxnetfree",
    storageBucket: "multidoxnetfree.firebasestorage.app",
    messagingSenderId: "248995370956",
    appId: "1:248995370956:web:455823a3778859bd4d2f69",
    measurementId: "G-HDE68S5TYS"
  };
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const auth = firebase.auth();

const tabla = document.getElementById("tablaRetiros");
const filtro = document.getElementById("filtroEstado");
const adminPermitido = "kevinaldaircamachoserna51@gmail.com";

auth.onAuthStateChanged(user => {
  if (!user || user.email !== adminPermitido) {
    document.body.innerHTML = "<h3>Acceso denegado</h3>";
    return;
  }

  db.ref("retiros").on("value", snapshot => {
    const data = snapshot.val() || {};
    const filtroValor = filtro.value;
    let items = Object.entries(data);
    if (["pendiente", "aprobado", "rechazado"].includes(filtroValor)) {
      items = items.filter(([k, v]) => v.estado === filtroValor);
    }
    if (filtroValor === "reciente") items.sort((a,b)=>b[0]-a[0]);
    if (filtroValor === "antiguo") items.sort((a,b)=>a[0]-b[0]);

    tabla.innerHTML = items.map(([id, d]) => `
      <tr>
        <td>${d.uid}</td>
        <td>${d.correo}</td>
        <td>S/ ${parseFloat(d.monto).toFixed(2)}</td>
        <td>${d.billetera}</td>
        <td>${d.numero}</td>
        <td class="fw-bold estado-${d.estado}">${d.estado.toUpperCase()}</td>
        <td>
          <button class='btn btn-success btn-sm' onclick="actualizarEstado('${id}', '${d.uid}', 'aprobado')">‚úî Aprobar</button>
          <button class='btn btn-danger btn-sm' onclick="actualizarEstado('${id}', '${d.uid}', 'rechazado')">‚úñ Rechazar</button>
        </td>
      </tr>
    `).join("");
  });
});

filtro.addEventListener("change", () => location.reload());

function actualizarEstado(id, uid, nuevoEstado) {
  db.ref("retiros/" + id).update({ estado: nuevoEstado }).then(() => {
    const mensaje = nuevoEstado === "aprobado"
      ? "‚úÖ Tu pago fue aprobado y el dinero ser√° enviado pronto."
      : "‚ùå Tu solicitud fue rechazada. Contacta con soporte.";

    db.ref("notificaciones/" + uid).push({
      mensaje,
      timestamp: Date.now()
    });

    alert("‚úî Estado actualizado y notificaci√≥n enviada.");
  });
}
</script>
</body>
</html>
