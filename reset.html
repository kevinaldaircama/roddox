<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Recuperar contraseña</title>

  <link rel="icon" href="3440119_ico.png" />
  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#0f2027" />

  <!-- Fuente -->
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet"/>

  <style>
    :root{
      --bg1:#0f2027; --bg2:#203a43; --bg3:#2c5364;
      --card:#ffffff; --text:#0b1220; --muted:#5b708b;
      --primary:#007bff; --primaryHover:#0056b3; --ring: rgba(0,123,255,.25);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background:linear-gradient(-45deg,var(--bg1),var(--bg2),var(--bg3),var(--bg1));
      background-size:400% 400%; animation: bgmove 18s ease infinite;
      margin:0; display:grid; place-items:center; padding:16px;
    }
    .container{
      width:100%; max-width:420px; background:var(--card); color:var(--text);
      border-radius:16px; padding:28px 24px; box-shadow:0 18px 42px rgba(0,0,0,.22)
    }
    .brand{display:flex; align-items:center; gap:12px; justify-content:center; margin-bottom:10px}
    .brand img{width:54px; height:54px; border-radius:12px}
    h1{font-size:1.35rem; margin:0}
    p.sub{color:var(--muted); margin:6px 0 18px; text-align:center}

    form{display:grid; gap:12px}
    .field{display:grid; gap:6px}
    label{font-size:.92rem; font-weight:600}
    input[type="email"]{
      width:100%; padding:12px 14px; border:1px solid #d7dce3; border-radius:10px; font-size:15px;
      outline:none; transition: box-shadow .15s ease, border-color .15s ease;
    }
    input:focus{border-color:var(--primary); box-shadow:0 0 0 4px var(--ring)}

    .g-recaptcha{margin: 6px 0 6px}

    button[type="submit"], .back{
      width:100%; border:none; border-radius:10px; padding:12px 14px; font-size:16px; font-weight:700; cursor:pointer;
      transition: transform .1s ease, background .2s ease, box-shadow .2s ease;
    }
    button[type="submit"]{ background:var(--primary); color:white; box-shadow:0 8px 18px rgba(0,123,255,.25) }
    button[type="submit"]:hover{ background:var(--primaryHover); transform: translateY(-1px) }
    button[disabled]{ opacity:.65; cursor:not-allowed; transform:none }

    .back{
      margin-top:10px; background:#fff; border:1px solid #d7dce3; color:#102033;
    }
    .back:hover{ box-shadow:0 0 0 4px rgba(0,0,0,.05) }

    .alert{
      display:none; margin:6px 0 2px; padding:10px 12px; border-radius:10px; font-size:.95rem;
      background:#fff4f4; color:#8a1f1f; border:1px solid #ffd6d6;
    }
    .alert.show{display:block}
    .ok{
      background:#f1fff4; color:#145a1a; border-color:#c9f0d1;
    }

    @keyframes bgmove{0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%}}
    @media (prefers-reduced-motion:reduce){ body{animation:none} }
  </style>

  <!-- Firebase (compat) + reCAPTCHA -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js" defer></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js" defer></script>
  <script src="https://www.google.com/recaptcha/api.js" async defer></script>
</head>
<body>

<div class="container" role="region" aria-label="Recuperar contraseña">
  <div class="brand">
    <img src="3440119_ico.png" alt="Logo Transferencia VIP" loading="lazy" decoding="async"/>
    <h1>Recuperar contraseña</h1>
  </div>
  <p class="sub">Ingresa tu correo y te enviaremos un enlace para restablecerla.</p>

  <div class="alert" id="alertBox" role="alert" aria-live="polite"></div>

  <form id="resetForm" autocomplete="on" novalidate>
    <div class="field">
      <label for="email">Correo electrónico</label>
      <input type="email" id="email" placeholder="correo@dominio.com" autocomplete="email" required />
    </div>

    <div class="g-recaptcha" data-sitekey="6LcXu4IrAAAAAKC8vZ5ALC0BeHZRqeA25RTkX1sI"></div>

    <button type="submit" id="submitBtn"><span class="btn-text">Enviar enlace</span></button>
  </form>

  <button class="back" id="backBtn">Volver a iniciar sesión</button>
</div>

<script>
  // ===== Helpers =====
  const $ = (s)=>document.querySelector(s);
  const showAlert = (msg, ok=false)=>{
    const box = $('#alertBox');
    box.textContent = msg;
    box.className = 'alert show' + (ok ? ' ok' : '');
  };
  const clearAlert = ()=>{
    const box = $('#alertBox');
    box.textContent = '';
    box.className = 'alert';
  };
  const getParam = (k)=> new URLSearchParams(location.search).get(k);

  // Preservar referido correcto (multidox-netfree) por si volvemos a login
  const REF_KEY = 'multidox-netfree';
  (function captureReferral(){
    const ref = getParam('ref');
    if (ref) { try { localStorage.setItem(REF_KEY, ref); localStorage.removeItem('tvip_ref'); } catch(e){} }
  })();
  function appendRef(url){
    try{
      const ref = getParam('ref') || localStorage.getItem(REF_KEY);
      if (ref) url.searchParams.set('ref', ref);
    }catch(e){}
  }

  // ===== Firebase =====
  window.addEventListener('DOMContentLoaded', () => {
    const firebaseConfig = {
      apiKey: "AIzaSyCbL1fRbwVZRhdD88TeQSFgpvfjZOMwfIg",
    authDomain: "multidoxnetfree.firebaseapp.com",
    projectId: "multidoxnetfree",
    appId: "1:248995370956:web:455823a3778859bd4d2f69",
  };

    firebase.initializeApp(firebaseConfig);

    const auth = firebase.auth();
    auth.languageCode = 'es'; // email en español

    // Si ya tiene sesión, mandamos a inicio
    auth.onAuthStateChanged((user)=>{
      if (user) {
        const url = new URL('inicio.html', location.href);
        appendRef(url);
        location.replace(url.toString());
      }
    });

    // UI
    const form = $('#resetForm');
    const submitBtn = $('#submitBtn');
    const btnTxt = submitBtn.querySelector('.btn-text');
    const setLoading = (v)=>{ submitBtn.disabled = v; btnTxt.textContent = v ? 'Enviando…' : 'Enviar enlace'; };

    // Enviar reset
    form.addEventListener('submit', async (e)=>{
      e.preventDefault();
      clearAlert();
      setLoading(true);

      try {
        const email = $('#email').value.trim().toLowerCase();
        if (!email) throw new Error('Ingresa tu correo.');

        const token = grecaptcha.getResponse();
        if (!token) throw new Error('Por favor verifica que no eres un robot.');

        // Enviar (mensaje genérico para no filtrar existencia)
        await auth.sendPasswordResetEmail(email);

        try { grecaptcha.reset(); } catch(e){}

        showAlert('Si existe una cuenta con ese correo, te enviamos un enlace para restablecer la contraseña. Revisa tu bandeja de entrada y el spam.', true);
      } catch (err) {
        console.error('[Reset error]', err);
        // Tratamos errores de formato o límites, pero mantenemos mensaje genérico para el resto
        if (err.code === 'auth/invalid-email') {
          showAlert('El correo no es válido.');
        } else if (err.code === 'auth/too-many-requests') {
          showAlert('Demasiados intentos. Intenta nuevamente más tarde.');
        } else {
          // Mensaje genérico para no exponer si el mail existe o no
          showAlert('Si existe una cuenta con ese correo, te enviamos un enlace para restablecer la contraseña. Revisa tu bandeja de entrada y el spam.', true);
        }
      } finally {
        setLoading(false);
      }
    });

    // Volver a login preservando ref
    $('#backBtn').addEventListener('click', ()=>{
      const url = new URL('login.html', location.href);
      appendRef(url);
      location.assign(url.toString());
    });
  });
</script>
</body>
  </html>
